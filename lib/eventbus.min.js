(function(a,b){if(typeof exports==="object"&&typeof module==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define("EventBus",[],b)}else{if(typeof exports==="object"){exports.EventBus=b()}else{a.EventBus=b()}}}})(this,function(){function d(m,l){m=m||[];var k={stop:function(i){this.isStopped=true;this.result=i},isStopped:false,result:undefined};for(var j in m){l(j,m[j],m,k);if(k.isStopped){break}}if(k.isStopped){return k.result}}function h(k,j,i){if(j>k.length){return[]}return[].slice.call(k,j===undefined?0:j,i===undefined?k.length:i)||[]}function b(m,j,l,i){if(typeof l=="string"||l instanceof Array){var k=l;if(typeof l=="string"){k=l.trim().split(e.DEFAULT.EVENT_TYPE_SPLIT_EXP)}if(k.length>1){d(k,function(n,o){i[0]=o;j.apply(m,i)});return m}else{l=k[0]}}return l}var c=(function(){var i=1000;return function(){return ++i}})();var e={};e=function(){this.listeners={};this.regexListeners=[]};e.prototype={on:function(l,o,k){l=b(this,this.on,l,h(arguments));if(l==this){return this}var n=l instanceof RegExp;var j=n?l.toString():l;var i=h(arguments);if(e.DEFAULT.SHOW_LOG){console.log("on=>listener args is ",i)}var m={id:c(),scope:k||{},callback:o,args:i,regExp:l,eventType:j};if(!n){if(typeof this.listeners[j]!="undefined"){this.listeners[j].push(m)}else{this.listeners[j]=[m]}}else{this.regexListeners.push(m)}return this},off:function(m,n,q){m=b(this,this.off,m,[undefined,n,q]);if(m==this){return this}var k=m instanceof RegExp;var j=k?m.toString():m;var o=[];if(typeof n=="object"){q=n;n=undefined}var l=n==undefined;var p=q==undefined;if(e.DEFAULT.SHOW_LOG){console.log("off=>off event type:",m," all callback:",l," all scope:",p)}function i(r){return(l?true:r.callback==n)&&(p?true:r.scope==q)}if(!k){if(typeof this.listeners[j]!="undefined"){if(!(l&&p)){d(this.listeners[j],function(r,s){if(!i(s)){o.push(s)}else{}})}this.listeners[j]=o}}else{d(this.regexListeners,function(r,s){if(!(s.eventType===j&&i(s))){o.push(s)}else{}});this.regexListeners=o}return this},has:function(m,p,l){var o=m instanceof RegExp;var j=o?m.toString():m;var k=[].concat(this.listeners[j]);if(typeof p=="object"){l=p;p=undefined}if(k.length>0&&!o){var n=k.length;if(p===undefined&&l===undefined){return n>0}var i=d(k,function(q,s,t,r){if((l?s.scope==l:true)&&(p?s.callback==p:true)){r.stop(true)}});if(i){return true}}else{if(o){k=[].concat(this.regexListeners);var i=d(k,function(q,s,t,r){if(s.regExp.toString()==j&&(l?s.scope==l:true)&&(p?s.callback==p:true)){r.stop(true)}});if(i){return true}}}return false},emit:function(n){var j=this.eventFlow=this.eventFlow||[];var k=h(arguments);n=b(this,this.emit,n,k);if(n==this){return this}var o={id:n+"#"+c(),type:n,target:k.length>1?k[1]:{}};k=[o].concat(h(arguments,1));var m=[].concat(typeof this.listeners[n]=="undefined"?[]:this.listeners[n]);var i=this;function p(s){var q=[].concat(j);var r=false;o.stop=function(){r=true};o.isStopped=function(){return r};o.getArg=function(t){if(o.args==undefined||!o.args instanceof Array||o.args.length-1<t){return undefined}return o.args[t]};o.flow={getEarlyEvent:function(){return q.slice(0,1).shift()},getClosestEvent:function(){return q.slice(0,q.length-1).pop()},getAllEvents:function(){return q.slice(0)},getEventIdsPath:function(t){return q.map(function(u){return u.id}).join(t||"==>")}};o.getLevel=function(){return q.length-1};d(s,function(u,z,x,w){if(z&&z.callback){var y=[].concat(k);if(e.DEFAULT.SHOW_LOG){console.log("emit=>event listener call arguments:",y)}o.args=[].concat(z.args);if(e.DEFAULT.SHOW_LOG){console.log("emit=>fire event listener:",z)}try{if(e.DEFAULT.SHOW_LOG){console.log("event flow:",o.flow.getEventIdsPath())}var t=i.beforeEmit;if(t&&typeof t=="function"){t.apply(i,[z].concat(y))}z.callback.apply(z.scope,y);t=i.afterEmit;if(t&&typeof t=="function"){t.apply(i,[z].concat(y))}}catch(v){r=true;i.emit(e.DEFAULT.ERROR_EVENT_TYPE,v,z,y)}if(r){w.stop()}}})}var l=[].concat(this.regexListeners);d(l,function(q,r){if(r.regExp.test(n)){m.push(r)}});j.push(o);p(m);j.pop();return this},getAllEvents:function(){var n="";for(var k in this.listeners){var m=this.listeners[k].length;for(var j=0;j<m;j++){var l=this.listeners[k][j];n+=l.scope&&l.scope.className?l.scope.className:"anonymous";n+=" listen for '"+k+"'\n"}}d([].concat(this.regexListeners),function(i,o){n+=o.scope&&o.scope.className?o.scope.className:"anonymous";n+=" listen for '"+o.eventType+"'\n"});return n}};var g=new e();var a=function(i){return g.emit.apply(g,h(arguments))};a.fn=e.prototype;a.plugin=function(i){i(a)};a.plugin(function(i){i.fn.bind=i.fn.addEventListener=i.fn.on;i.fn.unbind=i.fn.removeEventListener=i.fn.off;i.fn.trigger=i.fn.dispatch=i.fn.emit;i.fn.hasEventListener=i.fn.has});a.DEFAULT=e.DEFAULT={SHOW_LOG:false,EVENT_TYPE_SPLIT_EXP:/,|\s/,ERROR_EVENT_TYPE:"EMIT_ERROR"};a.plugin(function(i){i.fn.getCurrentEvent=function(){return[].concat(this.eventFlow).pop()};i.fn.getEarlyEvent=function(){return[].concat(this.eventFlow).shift()};i.fn.getClosestEvent=function(){return this.getCurrentEvent()?this.getCurrentEvent().flow.getClosestEvent():undefined}});a.plugin(function(i){i.fn.once=function(n,o,m){var j=this;var k=function(p){o.apply(this,h(arguments));j.off(n,k,m)};var l=h(arguments);l[1]=k;return j.on.apply(j,l)}});a.plugin(function(i){i.fn.flow=function(k){var l=h(arguments);if(k instanceof Array){l=k}var j=this;d(l,function(m,n){if(n instanceof Object&&typeof n=="object"&&n.from!=undefined&&n.to!=undefined){j.redirect(n.from,n.to,n.where,n.processor)}});return j}});a.plugin(function(i){i.fn.redirect=function(k,n,o,m){var j=this;if(k==undefined||n==undefined||k==n){return j}var l=this.redirectScope=this.redirectScope||{};m=typeof m=="function"?m:function(p){p.setEmitArgs(a.slice(arguments,1))};this.on(k,(function(s,t,q){if(t==undefined){t=function(){return true}}if(t instanceof RegExp){var r=t;t=function(u){return r.test(u.type)}}if(typeof t=="function"){var p=[];return function(w){var u=h(arguments);if(t.apply(l,u)){var v=typeof s=="function"?s.apply(l,u):s;if(p.indexOf(q)<0&&v!=w.type&&v!=undefined){p.push(q);try{if(typeof v=="string"){v=v.trim().split(e.DEFAULT.EVENT_TYPE_SPLIT_EXP)}if(!(v instanceof Array)){v=[v]}d(v,function(x,A,B,z){if(A!=w.type){var y=h([].concat(u),1);w.setEmitArgs=function(C){y=C};w.getEmitArgs=function(){return[].concat(y)};w.getOriginType=function(){return k};w.getEndpoint=function(){return A};w.isRedirect=function(){return true};w.endpoints=w.endpoints||[];w.endpoints.push(A);m.apply(l,u);y=(y instanceof Array)?[""].concat(y):[].concat(u);y[0]=A;if(e.DEFAULT.SHOW_LOG){console.log("redirect=>redirect id:",w.id," origin:",k," ==> endpoint:",A)}j.emit.apply(j,y);if(w.isStopped()){z.stop(true)}}})}finally{p.pop()}}else{throw"redirect origin:"+k.toString()+" => endpoint:"+s.toString()+"  is looping!"}}}}else{return function(u){if(e.DEFAULT.SHOW_LOG){console.log("redirect=>redirect condition must set function or RegExp!")}}}})(n,o,c()),l);return j}});a.plugin(function(k){var j={};function i(m,l,o){var n=j[m]=k.isArray(j[m])?j[m]:[];var p=k.fn[m];var q=k.isFunction(p);k.fn[m]=function(){var t=h(arguments);var r=this;var s;if(l==="before"||l==="around"){s=o.apply(r,[{name:m,orientation:l,args:t}])}if(q){s=p.apply(r,t)}if(l==="after"||l==="around"){s=o.apply(r,[{name:m,orientation:l,args:t},s])}return s};k.fn[m].aspect={orientation:l,next:p};return k}k.aspect=i;k.before=function(l,m){return k.aspect(l,"before",m)};k.after=function(l,m){return k.aspect(l,"after",m)};k.around=function(l,m){return k.aspect(l,"around",m)}});a.plugin(function(i){i.fn.beforeEmit=function(){};i.fn.afterEmit=function(){}});var f=function(i,j){return function(){return j.apply(i,h(arguments))}};d(e.prototype,function(i,j){if(j&&!a.hasOwnProperty(i)&&typeof j=="function"){a[i]=f(g,j)}});a.plugin(function(i){i.slice=h;i.nextId=c;i.iterator=d;i.hit=f;i.isFunction=function(j){return j&&typeof j==="function"};i.isArray=function(j){return j&&j.constructor.name=="Array"}});return a});