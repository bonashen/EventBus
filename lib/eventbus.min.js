(function(a,b){if(typeof exports==="object"&&typeof module==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define("EventBus",[],b)}else{if(typeof exports==="object"){exports.EventBus=b()}else{a.EventBus=b()}}}})(this,function(){function d(k,j){k=k||[];var h={stop:function(i){this.isStopped=true;this.result=i},isStopped:false,result:undefined};for(var g in k){j(g,k[g],k,h);if(h.isStopped){break}}if(h.isStopped){return h.result}}function f(i,h,g){if(h>i.length){return[]}return[].slice.call(i,h===undefined?0:h,g===undefined?i.length:g)||[]}function b(k,h,j,g){if(typeof j=="string"||j instanceof Array){var i=j;if(typeof j=="string"){i=j.trim().split(e.DEFAULT.EVENT_TYPE_SPLIT_EXP)}if(i.length>1){d(i,function(l,m){g[0]=m;h.apply(k,g)});return k}else{j=i[0]}}return j}var c=(function(){var g=1000;return function(){return ++g}})();var e={};e=function(){this.listeners={};this.regexListeners=[]};e.prototype={on:function(j,m,i){j=b(this,this.on,j,f(arguments));if(j==this){return this}var l=j instanceof RegExp;var h=l?j.toString():j;var g=f(arguments);if(e.DEFAULT.SHOW_LOG){console.log("on=>listener args is ",g)}var k={id:c(),scope:i||{},callback:m,args:g,regExp:j,eventType:h};if(!l){if(typeof this.listeners[h]!="undefined"){this.listeners[h].push(k)}else{this.listeners[h]=[k]}}else{this.regexListeners.push(k)}return this},once:function(k,l,j){var g=this;var h=function(m){l.apply(this,f(arguments));g.off(k,h,j)};var i=f(arguments);i[1]=h;return g.on.apply(g,i)},off:function(k,l,o){k=b(this,this.off,k,[undefined,l,o]);if(k==this){return this}var i=k instanceof RegExp;var h=i?k.toString():k;var m=[];if(typeof l=="object"){o=l;l=undefined}var j=l==undefined;var n=o==undefined;if(e.DEFAULT.SHOW_LOG){console.log("off=>off event type:",k," all callback:",j," all scope:",n)}function g(p){return(j?true:p.callback==l)&&(n?true:p.scope==o)}if(!i){if(typeof this.listeners[h]!="undefined"){if(!(j&&n)){d(this.listeners[h],function(p,q){if(!g(q)){m.push(q)}else{}})}this.listeners[h]=m}}else{d(this.regexListeners,function(p,q){if(!(q.eventType===h&&g(q))){m.push(q)}else{}});this.regexListeners=m}return this},redirect:function(h,k,l,j){var g=this;if(h==undefined||k==undefined||h==k){return g}var i=this.redirectScope=this.redirectScope||{};j=typeof j=="function"?j:function(m){m.setEmitArgs(a.slice(arguments,1))};this.on(h,(function(p,q,n){if(q==undefined){q=function(){return true}}if(q instanceof RegExp){var o=q;q=function(r){return o.test(r.type)}}if(typeof q=="function"){var m=[];return function(t){var r=f(arguments);if(q.apply(i,r)){var s=typeof p=="function"?p.apply(i,r):p;if(m.indexOf(n)<0&&s!=t.type&&s!=undefined){m.push(n);try{if(typeof s=="string"){s=s.trim().split(e.DEFAULT.EVENT_TYPE_SPLIT_EXP)}if(!(s instanceof Array)){s=[s]}d(s,function(u,w){if(w!=t.type){var v=f([].concat(r),1);t.setEmitArgs=function(x){v=x};t.getEmitArgs=function(){return[].concat(v)};t.getOriginType=function(){return h};t.getEndpoint=function(){return w};t.endpoints=t.endpoints||[];t.endpoints.push(w);j.apply(i,r);v=(v instanceof Array)?[""].concat(v):[].concat(r);v[0]=w;if(e.DEFAULT.SHOW_LOG){console.log("redirect=>redirect id:",t.id," origin:",h," ==> endpoint:",w)}g.emit.apply(g,v)}})}finally{m.pop()}}else{throw"redirect origin:"+h.toString()+" => endpoint:"+p.toString()+"  is looping!"}}}}else{return function(r){if(e.DEFAULT.SHOW_LOG){console.log("redirect=>redirect condition must set function or RegExp!")}}}})(k,l,c()),i);return g},flow:function(h){var i=f(arguments);if(h instanceof Array){i=h}var g=this;d(i,function(j,k){if(k instanceof Object&&typeof k=="object"&&k.from!=undefined&&k.to!=undefined){g.redirect(k.from,k.to,k.where,k.processor)}});return g},has:function(k,n,j){var m=k instanceof RegExp;var h=m?k.toString():k;var i=[].concat(this.listeners[h]);if(typeof n=="object"){j=n;n=undefined}if(i.length>0&&!m){var l=i.length;if(n===undefined&&j===undefined){return l>0}var g=d(i,function(o,q,r,p){if((j?q.scope==j:true)&&(n?q.callback==n:true)){p.stop(true)}});if(g){return true}}else{if(m){i=[].concat(this.regexListeners);var g=d(i,function(o,q,r,p){if(q.regExp.toString()==h&&(j?q.scope==j:true)&&(n?q.callback==n:true)){p.stop(true)}});if(g){return true}}}return false},emit:function(l){var h=this.eventFlow=this.eventFlow||[];var i=f(arguments);l=b(this,this.emit,l,i);if(l==this){return this}var m={id:l+"#"+c(),type:l,target:i.length>1?i[1]:{}};i=[m].concat(f(arguments,1));var k=[].concat(typeof this.listeners[l]=="undefined"?[]:this.listeners[l]);var g=this;function n(q){var o=[].concat(h);var p=false;m.stop=function(){p=true};m.getArg=function(r){if(m.args==undefined||!m.args instanceof Array||m.args.length-1<r){return undefined}return m.args[r]};m.flow={getEarlyEvent:function(){return o.slice(0,1).shift()},getClosestEvent:function(){return o.slice(0,o.length-1).pop()},getAllEvents:function(){return o.slice(0)}};m.getLevel=function(){return o.length-1};d(q,function(r,w,u,t){if(w&&w.callback){var v=[].concat(i);if(e.DEFAULT.SHOW_LOG){console.log("emit=>event listener call arguments:",v)}m.args=[].concat(w.args);if(e.DEFAULT.SHOW_LOG){console.log("emit=>fire event listener:",w)}try{w.callback.apply(w.scope,v)}catch(s){p=true;g.emit(g.DEFAULT.ERROR_EVENT_TYPE,s,w,v)}if(p){t.stop()}}})}var j=[].concat(this.regexListeners);d(j,function(o,p){if(p.regExp.test(l)){k.push(p)}});h.push(m);n(k);h.pop();return this},getAllEvents:function(){var l="";for(var h in this.listeners){var k=this.listeners[h].length;for(var g=0;g<k;g++){var j=this.listeners[h][g];l+=j.scope&&j.scope.className?j.scope.className:"anonymous";l+=" listen for '"+h+"'\n"}}d([].concat(this.regexListeners),function(i,m){l+=m.scope&&m.scope.className?m.scope.className:"anonymous";l+=" listen for '"+m.eventType+"'\n"});return l}};e.prototype.bind=e.prototype.addEventListener=e.prototype.on;e.prototype.unbind=e.prototype.removeEventListener=e.prototype.off;e.prototype.trigger=e.prototype.dispatch=e.prototype.emit;e.prototype.hasEventListener=e.prototype.has;var a=new e();a.slice=f;a.nextId=c;a.iterator=d;a.DEFAULT=e.DEFAULT={SHOW_LOG:false,EVENT_TYPE_SPLIT_EXP:/,|\s/,ERROR_EVENT_TYPE:"EMIT_ERROR"};return a});