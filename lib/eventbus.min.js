(function(a,b){if(typeof exports==="object"&&typeof module==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define("ebus",[],b)}else{if(typeof exports==="object"){exports.ebus=b()}else{a.ebus=b()}}}})(this,function(){function e(m,l){m=m||[];var k={stop:function(i){this.isStopped=true;this.result=i},isStopped:false,result:undefined};for(var j in m){l(j,m[j],m,k);if(k.isStopped){break}}if(k.isStopped){return k.result}}function h(k,j,i){if(j>k.length){return[]}return[].slice.call(k,j===undefined?0:j,i===undefined?k.length:i)||[]}function b(m,j,l,i){if(typeof l=="string"||l instanceof Array){var k=l;if(typeof l=="string"){k=l.trim().split(f.DEFAULT.EVENT_TYPE_SPLIT_EXP)}if(k.length>1){e(k,function(n,o){i[0]=o;j.apply(m,i)});return m}else{l=k[0]}}return l}var d=(function(){var i=1000;return function(){return ++i}})();var f={};f=function(){this.listeners={};this.regexListeners=[]};f.prototype={on:function(l,o,k){l=b(this,this.on,l,h(arguments));if(l==this){return this}var n=l instanceof RegExp;var j=n?l.toString():l;var i=h(arguments);if(f.DEFAULT.SHOW_LOG){console.log("on=>listener args is ",i)}var m={id:d(),scope:k||{},callback:o,args:i,regExp:l,eventType:j};if(!n){if(typeof this.listeners[j]!="undefined"){this.listeners[j].push(m)}else{this.listeners[j]=[m]}}else{this.regexListeners.push(m)}return this},off:function(m,n,q){m=b(this,this.off,m,[undefined,n,q]);if(m==this){return this}var k=m instanceof RegExp;var j=k?m.toString():m;var o=[];if(typeof n=="object"){q=n;n=undefined}var l=n==undefined;var p=q==undefined;if(f.DEFAULT.SHOW_LOG){console.log("off=>off event type:",m," all callback:",l," all scope:",p)}function i(r){return(l?true:r.callback==n)&&(p?true:r.scope==q)}if(!k){if(typeof this.listeners[j]!="undefined"){if(!(l&&p)){e(this.listeners[j],function(r,s){if(!i(s)){o.push(s)}else{}})}this.listeners[j]=o}}else{e(this.regexListeners,function(r,s){if(!(s.eventType===j&&i(s))){o.push(s)}else{}});this.regexListeners=o}return this},has:function(m,p,l){var o=m instanceof RegExp;var j=o?m.toString():m;var k=[].concat(this.listeners[j]);if(typeof p=="object"){l=p;p=undefined}if(k.length>0&&!o){var n=k.length;if(p===undefined&&l===undefined){return n>0}var i=e(k,function(q,s,t,r){if((l?s.scope==l:true)&&(p?s.callback==p:true)){r.stop(true)}});if(i){return true}}else{if(o){k=[].concat(this.regexListeners);var i=e(k,function(q,s,t,r){if(s.regExp.toString()==j&&(l?s.scope==l:true)&&(p?s.callback==p:true)){r.stop(true)}});if(i){return true}}}return false},emit:function(n){var j=this.eventFlow=this.eventFlow||[];var k=h(arguments);n=b(this,this.emit,n,k);if(n==this){return this}var o={id:n+"#"+d(),type:n,target:k.length>1?k[1]:{}};k=[o].concat(h(arguments,1));var m=[].concat(typeof this.listeners[n]=="undefined"?[]:this.listeners[n]);var i=this;function p(s){var q=[].concat(j);var r=false;o.stop=function(){r=true};o.isStopped=function(){return r};o.getArg=function(t){if(o.args==undefined||!o.args instanceof Array||o.args.length-1<t){return undefined}return o.args[t]};o.flow={getEarlyEvent:function(){return q.slice(0,1).shift()},getClosestEvent:function(){return q.slice(0,q.length-1).pop()},getAllEvents:function(){return q.slice(0)},getEventIdsPath:function(t){return q.map(function(u){return u.id}).join(t||"==>")}};o.getLevel=function(){return q.length-1};e(s,function(t,y,w,v){if(y&&y.callback){var x=[].concat(k);if(f.DEFAULT.SHOW_LOG){console.log("emit=>event listener call arguments:",x)}o.args=[].concat(y.args);if(f.DEFAULT.SHOW_LOG){console.log("emit=>fire event listener:",y)}try{if(f.DEFAULT.SHOW_LOG){console.log("event flow:",o.flow.getEventIdsPath())}y.callback.apply(y.scope,x)}catch(u){r=true;i.emit(i.DEFAULT.ERROR_EVENT_TYPE,u,y,x)}if(r){v.stop()}}})}var l=[].concat(this.regexListeners);e(l,function(q,r){if(r.regExp.test(n)){m.push(r)}});j.push(o);p(m);j.pop();return this},getAllEvents:function(){var n="";for(var k in this.listeners){var m=this.listeners[k].length;for(var j=0;j<m;j++){var l=this.listeners[k][j];n+=l.scope&&l.scope.className?l.scope.className:"anonymous";n+=" listen for '"+k+"'\n"}}e([].concat(this.regexListeners),function(i,o){n+=o.scope&&o.scope.className?o.scope.className:"anonymous";n+=" listen for '"+o.eventType+"'\n"});return n}};f.prototype.bind=f.prototype.addEventListener=f.prototype.on;f.prototype.unbind=f.prototype.removeEventListener=f.prototype.off;f.prototype.trigger=f.prototype.dispatch=f.prototype.emit;f.prototype.hasEventListener=f.prototype.has;var g=new f();var a=function(i){return g.emit.apply(g,h(arguments))};var c=function(i,j){return function(){return j.apply(i,h(arguments))}};e(f.prototype,function(i,j){if(j&&!a.hasOwnProperty(i)&&typeof j=="function"){a[i]=c(g,j)}});a.fn=f.prototype;a.plugin=function(i){i(a)};a.slice=h;a.nextId=d;a.iterator=e;a.DEFAULT=f.DEFAULT={SHOW_LOG:false,EVENT_TYPE_SPLIT_EXP:/,|\s/,ERROR_EVENT_TYPE:"EMIT_ERROR"};a.plugin(function(i){i.fn.once=function(n,o,m){var j=this;var k=function(p){o.apply(this,h(arguments));j.off(n,k,m)};var l=h(arguments);l[1]=k;return j.on.apply(j,l)}});a.plugin(function(i){i.fn.flow=function(k){var l=h(arguments);if(k instanceof Array){l=k}var j=this;e(l,function(m,n){if(n instanceof Object&&typeof n=="object"&&n.from!=undefined&&n.to!=undefined){j.redirect(n.from,n.to,n.where,n.processor)}});return j}});a.plugin(function(i){i.fn.redirect=function(k,n,o,m){var j=this;if(k==undefined||n==undefined||k==n){return j}var l=this.redirectScope=this.redirectScope||{};m=typeof m=="function"?m:function(p){p.setEmitArgs(a.slice(arguments,1))};this.on(k,(function(s,t,q){if(t==undefined){t=function(){return true}}if(t instanceof RegExp){var r=t;t=function(u){return r.test(u.type)}}if(typeof t=="function"){var p=[];return function(w){var u=h(arguments);if(t.apply(l,u)){var v=typeof s=="function"?s.apply(l,u):s;if(p.indexOf(q)<0&&v!=w.type&&v!=undefined){p.push(q);try{if(typeof v=="string"){v=v.trim().split(f.DEFAULT.EVENT_TYPE_SPLIT_EXP)}if(!(v instanceof Array)){v=[v]}e(v,function(x,A,B,z){if(A!=w.type){var y=h([].concat(u),1);w.setEmitArgs=function(C){y=C};w.getEmitArgs=function(){return[].concat(y)};w.getOriginType=function(){return k};w.getEndpoint=function(){return A};w.endpoints=w.endpoints||[];w.endpoints.push(A);m.apply(l,u);y=(y instanceof Array)?[""].concat(y):[].concat(u);y[0]=A;if(f.DEFAULT.SHOW_LOG){console.log("redirect=>redirect id:",w.id," origin:",k," ==> endpoint:",A)}j.emit.apply(j,y);if(w.isStopped()){z.stop(true)}}})}finally{p.pop()}}else{throw"redirect origin:"+k.toString()+" => endpoint:"+s.toString()+"  is looping!"}}}}else{return function(u){if(f.DEFAULT.SHOW_LOG){console.log("redirect=>redirect condition must set function or RegExp!")}}}})(n,o,d()),l);return j}});return a});